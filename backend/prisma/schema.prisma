generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String   @id @default(cuid())
  name                    String
  email                   String   @unique
  passwordHash            String   @map("password_hash")
  role                    Role
  active                  Boolean  @default(true)
  basicContributionAmount Float?   @map("basic_contribution_amount")
  createdAt               DateTime @default(now()) @map("created_at")

  contributions           Contribution[]
  basicPayments           BasicContributionPayment[]
  submittedExpenses       Expense[] @relation("ExpenseSubmitter")
  approvedExpenses        Expense[] @relation("ExpenseApprover")
  createdMeetings         Meeting[] @relation("MeetingCreator")
  meetingParticipations   MeetingParticipant[]
  actionItemAssignments   ActionItemAssignee[]
  profile                 AlumniProfile?
  auditLogs               AuditLog[]
}

model Contribution {
  id         String             @id @default(cuid())
  user       User               @relation(fields: [userId], references: [id])
  userId     String
  amount     Float
  date       DateTime
  notes      String?
  type       ContributionType   @default(ADDITIONAL)
  status     ContributionStatus @default(PENDING)
  createdBy  String?            @map("created_by")
  approvedBy String?            @map("approved_by")
  approvedAt DateTime?          @map("approved_at")
  createdAt  DateTime           @default(now()) @map("created_at")
}

model Event {
  id          String   @id @default(cuid())
  name        String
  description String?
  date        DateTime?
  createdAt   DateTime @default(now()) @map("created_at")
  expenses    Expense[]
}

model Expense {
  id          String        @id @default(cuid())
  amount      Float
  vendor      String?
  purpose     String
  description String?
  date        DateTime
  category    String
  eventId     String?
  event       Event?        @relation(fields: [eventId], references: [id], onDelete: SetNull)

  // Approval workflow
  status      ExpenseStatus @default(PENDING)
  submittedBy String?       @map("submitted_by")
  submitter   User?         @relation("ExpenseSubmitter", fields: [submittedBy], references: [id])
  approvedBy  String?       @map("approved_by")
  approver    User?         @relation("ExpenseApprover", fields: [approvedBy], references: [id])
  approvedAt  DateTime?     @map("approved_at")

  createdAt   DateTime      @default(now()) @map("created_at")
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  message   String
  createdAt DateTime @default(now()) @map("created_at")
}

enum Role {
  ADMIN
  ALUMNI
}

enum ContributionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ContributionType {
  BASIC
  ADDITIONAL
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
}

model BasicContributionPayment {
  id        String    @id @default(cuid())
  user      User      @relation(fields: [userId], references: [id])
  userId    String
  year      Int
  month     Int
  amount    Float
  paid      Boolean   @default(false)
  paidAt    DateTime? @map("paid_at")
  paidBy    String?   @map("paid_by")
  createdAt DateTime  @default(now()) @map("created_at")

  @@unique([userId, year, month])
  @@map("basic_contribution_payment")
}

enum ActionItemStatus {
  PENDING
  COMPLETED
}

model Meeting {
  id          String   @id @default(cuid())
  title       String?
  date        DateTime
  startTime   String   @map("start_time")
  endTime     String   @map("end_time")
  location    String
  notes       String?  @db.Text
  createdBy   String   @map("created_by")
  creator     User     @relation("MeetingCreator", fields: [createdBy], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  participants MeetingParticipant[]
  actionItems  ActionItem[]

  @@map("meeting")
}

model MeetingParticipant {
  id        String   @id @default(cuid())
  meeting   Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  meetingId String   @map("meeting_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([meetingId, userId])
  @@map("meeting_participant")
}

model ActionItem {
  id          String           @id @default(cuid())
  description String
  targetDate  DateTime         @map("target_date")
  status      ActionItemStatus @default(PENDING)
  meeting     Meeting          @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  meetingId   String           @map("meeting_id")
  completedAt DateTime?        @map("completed_at")
  createdAt   DateTime         @default(now()) @map("created_at")

  assignees   ActionItemAssignee[]

  @@map("action_item")
}

model ActionItemAssignee {
  id           String     @id @default(cuid())
  actionItem   ActionItem @relation(fields: [actionItemId], references: [id], onDelete: Cascade)
  actionItemId String     @map("action_item_id")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String     @map("user_id")
  createdAt    DateTime   @default(now()) @map("created_at")

  @@unique([actionItemId, userId])
  @@map("action_item_assignee")
}

model AlumniProfile {
  id               String   @id @default(cuid())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String   @unique @map("user_id")

  // Education (structured - all mandatory)
  degree           String
  institution      String
  graduationYear   Int      @map("graduation_year")

  // DOB (mandatory)
  dateOfBirth      DateTime @map("date_of_birth")

   // Optional fields
   contactNumber    String?  @map("contact_number")
   shareContactNumber Boolean @default(true) @map("share_contact_number")
   currentResidence String?  @map("current_residence")
   profession       String?
   linkedinProfile  String?  @map("linkedin_profile")

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  jobHistory       JobHistory[]

  @@map("alumni_profile")
}

model JobHistory {
  id             String        @id @default(cuid())
  profile        AlumniProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  profileId      String        @map("profile_id")

  companyName    String        @map("company_name")
  role           String
  startDate      DateTime      @map("start_date")
  companyWebsite String?       @map("company_website")
  endDate        DateTime?     @map("end_date")

  createdAt      DateTime      @default(now()) @map("created_at")

  @@map("job_history")
}

model AuditLog {
  id         String          @id @default(cuid())
  entityType AuditEntityType @map("entity_type")
  entityId   String          @map("entity_id")
  action     AuditAction
  user       User            @relation(fields: [userId], references: [id])
  userId     String          @map("user_id")
  timestamp  DateTime        @default(now())
  notes      String?         @db.Text

  @@map("audit_log")
}

enum AuditEntityType {
  EXPENSE
  CONTRIBUTION
}

enum AuditAction {
  APPROVED
  REJECTED
}
